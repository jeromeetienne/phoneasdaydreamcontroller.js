<!doctype html>
<html>
<meta charset='utf-8'>
<title>PhoneAsGamePad : phone page</title>
<meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, shrink-to-fit=no'>
<meta name='mobile-web-app-capable' content='yes'>
<meta name='apple-mobile-web-app-capable' content='yes' />
<meta name='apple-mobile-web-app-status-bar-style' content='black-translucent' />
<head>
	<title>Phone Gamepad</title>
</head>
<link rel="stylesheet" href="css/gamepad.css">
<div id="container">
	<div id="trackpad">Trackpad</div>    
	<div id="bottomRow">
		<div id="homeButton">Home Button</div>
		<div id="appButton">App Button</div>
	</div>
</div>
<script>
function getQueryVariable(variable) {
	var query = window.location.hash.substring(1);
	var vars = query.split('&');
	for (var i = 0; i < vars.length; i++) {
		var pair = vars[i].split('=');
		if (decodeURIComponent(pair[0]) === variable) {
			if (pair[1] === undefined) return true
			return decodeURIComponent(pair[1]);
		}
	}
	return undefined
}
var queryParameters = {
	hand : getQueryVariable('hand'),
	gamepadIndex : getQueryVariable('gamepadIndex') ? parseInt(getQueryVariable('gamepadIndex'),10) : undefined,
}

var hasParameters = (queryParameters.hand === undefined || queryParameters.gamepadIndex === undefined) ? false : true
if( hasParameters === false )	alert('PANIC no url parameter')


</script>

<script src="../../node_modules/socket.io/node_modules/socket.io-client/socket.io.js"></script>
<script>
var serverUrl = 'http://'+location.hostname+':4000'
var socket = io(serverUrl, { 
	query: "origin=phone"
		+ "&hand=" + encodeURIComponent(queryParameters.hand)
		+ "&gamepadIndex=" + encodeURIComponent(queryParameters.gamepadIndex)
});

//////////////////////////////////////////////////////////////////////////////
//		Code Separator
//////////////////////////////////////////////////////////////////////////////
socket.on('appconnected', function(){
	console.log('app connected')
})
socket.on('appdisconnected', function(){
	console.log('app disconnected')
})


//////////////////////////////////////////////////////////////////////////////
//		prevent default for touch events
//////////////////////////////////////////////////////////////////////////////

document.querySelector('body').addEventListener('touchstart', function(event){ event.preventDefault() })
document.querySelector('body').addEventListener('touchend', function(event){ event.preventDefault() })
document.querySelector('body').addEventListener('touchmove', function(event){ event.preventDefault() })


//////////////////////////////////////////////////////////////////////////////
//		Handle button
//////////////////////////////////////////////////////////////////////////////
document.querySelector('#homeButton').addEventListener('touchstart', function(){
	document.querySelector('#homeButton').classList.add('touched')
	sendButtonsEvent('touchstart', 'homeButton')
})
document.querySelector('#homeButton').addEventListener('touchend', function(){
	document.querySelector('#homeButton').classList.remove('touched')
	sendButtonsEvent('touchend', 'homeButton')
})
document.querySelector('#appButton').addEventListener('touchstart', function(){
	document.querySelector('#appButton').classList.add('touched')
	sendButtonsEvent('touchstart', 'appButton')
})
document.querySelector('#appButton').addEventListener('touchend', function(){
	document.querySelector('#appButton').classList.remove('touched')
	sendButtonsEvent('touchend', 'appButton')
})

function sendButtonsEvent(type, target){
	var event = {
		type : type,
		gamepadIndex: queryParameters.gamepadIndex,
		// data properties
		target : target,
	}
	socket.emit('forwardToApp', JSON.stringify(event))		
}

//////////////////////////////////////////////////////////////////////////////
//		Handle trackpad
//////////////////////////////////////////////////////////////////////////////

document.querySelector('#trackpad').addEventListener('touchstart', function(event){
	document.querySelector('#trackpad').classList.add('touched')
	sendTrackpadEvent(event)
})
document.querySelector('#trackpad').addEventListener('touchend', function(event){
	document.querySelector('#trackpad').classList.remove('touched')
	sendTrackpadEvent(event)
})

document.querySelector('#trackpad').addEventListener('touchmove', function(event){
	sendTrackpadEvent(event)
})

function sendTrackpadEvent(domEvent){
	var event = {
		type : domEvent.type,
		gamepadIndex: queryParameters.gamepadIndex,
		// data properties
		target : 'trackpad'
	}

	var touch = domEvent.touches[0]
	if( touch ){
		var trackpadElement = document.querySelector('#trackpad')
		var boundRect = trackpadElement.getBoundingClientRect()
		event.positionX = (touch.clientX / boundRect.width - 0.5) * 2
		event.positionY = (touch.clientY / boundRect.height- 0.5) * 2
	}else{
		event.positionX = 0
		event.positionY = 0
	}

	socket.emit('forwardToApp', JSON.stringify(event))		
}

//////////////////////////////////////////////////////////////////////////////
//		display touch on trackpad
//////////////////////////////////////////////////////////////////////////////
var img = document.createElement('img')
img.src = 'images/sprite0.png'
img.style.display = 'none'
img.style.position = 'absolute'
img.style.width = '30%'
img.style.marginTop = '-15%'
img.style.marginLeft = '-15%'
img.style.pointerEvents = 'none'
document.body.appendChild(img)
function updateImgPosition(domEvent){
	var touch = domEvent.touches[0]
	if( touch ){
		img.style.left = touch.clientX+'px'
		img.style.top = touch.clientY+'px'
		img.style.display = 'block'
		
		var trackpadElement = document.querySelector('#trackpad')
		var boundRect = trackpadElement.getBoundingClientRect()
		if( touch.clientY > boundRect.height ){
			img.style.display = 'none'
		}
	}else{
		img.style.display = 'none'
	}
	
}
document.querySelector('#trackpad').addEventListener('touchstart', updateImgPosition)
document.querySelector('#trackpad').addEventListener('touchend', updateImgPosition)
document.querySelector('#trackpad').addEventListener('touchmove', updateImgPosition)



////////////////////////////////////////////////////////////////////////////////
//          Handle calibration reset
////////////////////////////////////////////////////////////////////////////////

;(function(){
	var timerId = null
	document.querySelector('#homeButton').addEventListener('touchstart', function(){
		stopTimerIfNeeded()
		timerId = setTimeout(function(){
			stopTimerIfNeeded()
			socket.emit('forwardToApp', JSON.stringify({
				type : 'deviceOrientationReset',
				gamepadIndex: queryParameters.gamepadIndex,
			}))			
		}, 1000*0.5)
	})
	document.querySelector('#homeButton').addEventListener('touchend', function(){
		stopTimerIfNeeded()
	})
	function stopTimerIfNeeded(){
		if( timerId !== null ) clearTimeout(timerId)
		timerId = null	
	}
})()


//////////////////////////////////////////////////////////////////////////////
//		forward the device orientation
//////////////////////////////////////////////////////////////////////////////
window.addEventListener("deviceorientation", onDeviceOrientation, true);
function onDeviceOrientation(event) {
	// console.log('onDeviceOrientation')
	var event = {
		type : 'deviceOrientation',
		gamepadIndex: queryParameters.gamepadIndex,
		// data properties
		alpha : event.alpha,
		beta : event.beta,
		gamma : event.gamma,
	}
	socket.emit('forwardToApp', JSON.stringify(event))
}
</script>


<script src="vendor/nosleep.js"></script>
<script>
//////////////////////////////////////////////////////////////////////////////
//		Handle noSleep
//////////////////////////////////////////////////////////////////////////////
;(function(){
	var noSleep = new NoSleep();
	
	// Enable wake lock.
	// (must be wrapped in a user input event handler e.g. a mouse or touch handler)
	document.addEventListener('touchstart', function enableNoSleep() {
		noSleep.enable();
		document.removeEventListener('touchstart', enableNoSleep, false);
	}, false);
})()
</script>
<!-- <script type="text/javascript">
	document.querySelector('#container').addEventListener('touchstart', function onClick(event){
		document.querySelector('#container').removeEventListener('touchstart', onClick);
		var element = document.querySelector('#container')
		if (element.requestFullscreen) {
			element.requestFullscreen();
		} else if (element.mozRequestFullScreen) {
			element.mozRequestFullScreen();
		} else if (element.webkitRequestFullscreen) {
			element.webkitRequestFullscreen();
		} else if (element.msRequestFullscreen) {
			element.msRequestFullscreen();
		}
	})
</script> -->
</html>
